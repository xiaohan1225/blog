import{_ as i,o as a,c as n,ae as t}from"./chunks/framework.BrbCc44R.js";const g=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"note/performance/output/如何采集白屏和卡顿指标？.md","filePath":"note/performance/output/如何采集白屏和卡顿指标？.md"}'),l={name:"note/performance/output/如何采集白屏和卡顿指标？.md"};function p(h,s,k,e,r,E){return a(),n("div",null,[...s[0]||(s[0]=[t(`<p>作为一名前端工程师，我们常说“性能即体验”。但“性能”这个词太宏大，具体落实到用户感知的层面，其实主要就是两件事：<strong>我打开页面的速度快不快？界面操作顺不顺畅?</strong></p><p>而在前端性能指标中，与此相对应的分别是<strong>白屏指标</strong>和<strong>卡顿指标</strong>。</p><h2 id="_1、白屏时间、首屏时间和卡顿时间的区别" tabindex="-1">1、白屏时间、首屏时间和卡顿时间的区别 <a class="header-anchor" href="#_1、白屏时间、首屏时间和卡顿时间的区别" aria-label="Permalink to &quot;1、白屏时间、首屏时间和卡顿时间的区别&quot;">​</a></h2><p><strong>想象一下你去机场坐飞机：</strong></p><ul><li><strong>白屏时间</strong>：从机场大厅排队走到安检柜台前的那段时间。</li><li><strong>首屏时间</strong>：过机场安检的时间。</li><li><strong>卡顿时间</strong>：排队停止了。比如前面的人突然停下找身份证，也就是排队的队伍停止了，你就得等着，这就是卡顿。</li></ul><p><strong>具体反映在用户体验上：</strong></p><ul><li><strong>白屏时间</strong>：用户从点击链接到看到第一个字符出现的时间。</li><li><strong>首屏时间</strong>：用户从点击链接到看到主要内容出现的时间。</li><li><strong>卡顿时间</strong>：用户在操作过程中，由于浏览器或 App 处理其他任务而导致的延迟。比如点击按钮后，页面很久才有反应，这就是卡顿。</li></ul><h2 id="_2、白屏时间" tabindex="-1">2、白屏时间 <a class="header-anchor" href="#_2、白屏时间" aria-label="Permalink to &quot;2、白屏时间&quot;">​</a></h2><p>在浏览器中，<strong>白屏时间</strong>指的是从用户按下回车（或点击链接）开始，到页面上出现第一个字符的时间。</p><p><strong>怎么采集白屏时间呢？</strong></p><p><strong>浏览器环境：</strong></p><p>我们可以利用浏览器的 <code>Performance API</code> 来计算：</p><blockquote><p><strong>白屏时间 = <code>domLoading</code> - <code>navigationStart</code></strong></p></blockquote><p>其中，<code>domLoading</code> 表示<strong>浏览器开始解析 DOM 结构的时间</strong>，首屏时间就是指浏览器开始解析 DOM 结构的时间减去导航开始的时间。</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getDomLoadingTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">window.performance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">window.performance.timing) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> timing</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> window.performance.timing;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> navigationStart</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> timing.navigationStart;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> domLoading</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> timing.domLoading;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (navigationStart </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> domLoading </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> domLoading </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> navigationStart;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;load&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> domLoadingTime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getDomLoadingTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (domLoadingTime) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;DOM 开始解析时间:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, domLoadingTime, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;ms&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><p><strong>App (WebView) 环境：</strong></p><p>与浏览器环境不同的是，在 <code>APP(Webview)</code> 环境中，多了一个启动浏览器内核，也就是 <code>Webview</code> 初始化的过程，这就好比你要过安检，安检员需要先把安检机器给打开。</p><p>所以在这个环境下，检测白屏时间需要 APP 端配合。在 APP 创建 Webview 时，需要打一个点，在开始建立网络连接时，再打一个点，这两个点之间的差值，就是初始化的耗时，在计算白屏时间的时候，需要加上这部分的耗时。</p><blockquote><p>当然，我们也可以通过<strong>并行初始化</strong>的方案，来规避掉这部分的耗时。也就是在 APP 启动时，并行初始化 <code>Webview</code>，并放入 <code>Webview</code> 池，当用户需要打开 H5 页面时，直接从池子里取出来，而不需要重新初始化。当然，也需要对 <code>Webview</code> 池进行最大容量限制，避免内存占用过多。</p></blockquote><h2 id="_3、卡顿" tabindex="-1">3、卡顿 <a class="header-anchor" href="#_3、卡顿" aria-label="Permalink to &quot;3、卡顿&quot;">​</a></h2><p><strong>卡顿</strong>很好理解，直白点来说就是页面“卡”住了。比如用户点击了一个按钮，但是页面过了 3-4s 才有反应，或者页面某些动画看起来很不流畅，这都是卡顿的现象。</p><p><strong>怎么判定卡顿呢？</strong></p><p>FPS（Frames Per Second），即<strong>每秒帧数</strong>，是衡量页面流畅度的一个指标。一般来说，<strong>FPS 超过 60 就可以认为是流畅的</strong>，也就是单帧渲染时间在 16.6ms（1000ms / 60） 以下。</p><p>不过也有一些极端情况，比如玩游戏时，前 0.9 秒就渲染了 59 帧，单最后 0.1 秒一帧都没渲染，这样平均下来 FPS 还是 59，但用户在那 0.1 秒会感觉到明显的“掉帧”。所以，为了更准确的衡量卡顿，我们不能简单用单帧平均渲染时间来判断。</p><p><strong>浏览器环境：</strong></p><p>浏览器并没有直接提供 FPS 指标，但是我们可以通过 <code>requestAnimationFrame</code> 来变相计算。</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 统计FPS</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> calculateFPS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> performance.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> frameCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> animate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> currentTime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> performance.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> deltaTime</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lastTime;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (deltaTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fps</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> frameCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (deltaTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;当前 FPS:&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, fps);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      lastTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> currentTime;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      frameCount </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    frameCount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    requestAnimationFrame</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(animate);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  animate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><blockquote><p><strong>判定标准</strong>：如果连续 3 帧的刷新频率都低于 20 FPS，且保持恒定，往往意味着出现了卡顿。</p></blockquote><p><strong>App 环境：</strong> App 原生可以拿到每一帧的具体渲染耗时。</p><blockquote><p><strong>判定标准</strong>：</p><ul><li>一般卡顿：连续 5 帧渲染时间超过 50ms。</li><li>严重卡顿：单帧渲染时间超过 250ms。</li></ul></blockquote><h2 id="_4、如何采集用户的网络环境" tabindex="-1">4、如何采集用户的网络环境？ <a class="header-anchor" href="#_4、如何采集用户的网络环境" aria-label="Permalink to &quot;4、如何采集用户的网络环境？&quot;">​</a></h2><p>用户的网络环境有很多种，比如 5G、4G、WiFi、3G/2G 等。我们可以通过采集用户的网络环境，来了解用户的真实网络情况，从而更好的优化用户体验。</p><p>一般来说，我们可以采取<strong>图片测速法</strong>来采集用户的网络环境。</p><ul><li>加载两张图片，一张极小的（1x1像素），一张稍大的（3x3像素）。</li><li>记录图片请求开始到 <code>onLoad</code> 完成的时间。</li><li>计算速度：<code>文件大小 / 加载时间 = 网速</code>。</li><li>取平均值，把两个数据取个平均值，减少误差。</li></ul><p>拿到用户数据后，我们可以画出用户的网速分布图，这为我们优化用户体验提供了数据支撑。比如视频播放时，不同网络环境下的用户，分别加载不同清晰度的视频，高清、标清、流畅等。</p><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2>`,36)])])}const o=i(l,[["render",p]]);export{g as __pageData,o as default};
