import{_ as i,o as e,c as s,ae as a}from"./chunks/framework.h0LyDJ8h.js";const k=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"note/performance/11.工具实践：如何进行性能专项测试.md","filePath":"note/performance/11.工具实践：如何进行性能专项测试.md"}'),l={name:"note/performance/11.工具实践：如何进行性能专项测试.md"};function n(p,t,h,d,r,o){return e(),s("div",null,[...t[0]||(t[0]=[a(`<h2 id="引言" tabindex="-1">引言 <a class="header-anchor" href="#引言" aria-label="Permalink to &quot;引言&quot;">​</a></h2><p>如果有新业务要上线，如何尽量避免它上线后的前端性能问题，避免以后我们手忙脚乱去“救火”呢？</p><p>性能专项测试：在业务上线前，我们对性能指标（如首屏时间、白屏时间、页面加载时长等）进行测试，确保上线后性能指标达标。</p><p>步骤如下：</p><ol><li>确定线下测试方案</li><li>设定线下的测试标准</li><li>选用合适的测试环境进行测试及视频的分帧计算</li><li>输出测试结果</li></ol><h2 id="性能测试方案选型" tabindex="-1">性能测试方案选型 <a class="header-anchor" href="#性能测试方案选型" aria-label="Permalink to &quot;性能测试方案选型&quot;">​</a></h2><p>使用性能 SDK 和以录视频的方式。</p><p>性能SDK：优点是线上和线下的方案一致，缺点是因为业务还没上线，内网测试的访问量有限，无法形成大量的首屏时间分布数据，也就无法在性能平台上可视化数据。</p><ul><li>比如我们要采集首屏时间指标，就使用 MutationObserver。</li></ul><p>以录制视频的方式进行性能测试：优点是可以和 QA 现有基础设施（由于测试项目较多，在这个过程中，QA团队会沉淀一些基础设施，比如对 APP 代码覆盖率测试工具、异常测试平台、数据构造集成测试平台等）相结合，QA 测试不仅会测 H5 页面的首屏时间，还会测试 Native 页面的响应时间，以及 APP 内存使用和 CPU 占用等信息。</p><p>在性能测试上，我一般建议采用录制视频的方式来进行。</p><p>录制视频一般有手动方案和自动化方案。所谓手动方案就是通过手机自带的视频录制功能来进行，而自动化方案则是通过 adb 录制。</p><p>adb 是 android studio 下提供的一个工具，在电脑上通过它可以控制模拟器或者真实的手机设备，需要通过数据线连接到电脑。比如可以通过它打开一个 app 页面，运行 shell 命令，安装软件等功能。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 录屏时间为 10 s，如果不设置默认时间是 180 s</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">adb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> shell</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> screenrecord</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --time-limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sdcard/perf.mp4</span></span></code></pre></div><p>打开一个 app 页面，页面开始加载，然后在页面加载结束后，点击 ctrl + c 结束录屏。</p><p>录制的坑：</p><ol><li>有些设备的显示如分辨率过高可能无法录制。可以通过指定分辨率来解决这个问题。</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">adb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> shell</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> screenrecord</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --size</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1280x720</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --time-limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sdcard/perf.mp4</span></span></code></pre></div><ol start="2"><li>如果使用模拟器。要注意模拟器在晃动、多点触摸等操作情况下替代不了真机，模拟器在性能和设备类型上也要慢一些，上限取决于你电脑的性能上限。</li><li>录制过程中不要旋转手机，因为这会造成页面切断。</li><li>可以通过添加 verbose 参数打印中执行过程中的信息，帮助调试。</li></ol><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">adb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> shell</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> screenrecord</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --time-limit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --verbose</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /sdcard/perf.mp4</span></span></code></pre></div><h2 id="性能测试标准设定" tabindex="-1">性能测试标准设定 <a class="header-anchor" href="#性能测试标准设定" aria-label="Permalink to &quot;性能测试标准设定&quot;">​</a></h2><p>有关性能标准，我在第一讲里的关键指标设定介绍过，也在模块二专门说明了首屏时间、白屏时间、卡顿等的指标采集方案。</p><p>首屏时间的性能指标设定需要注意两点：</p><ol><li>分频计算的标准，也就是什么时候认为首屏结束。</li><li>确定首屏时间的标准。</li></ol><ul><li>白屏响应时间 = 白屏最后一帧的时间 - 点击时的起始帧时间</li><li>首屏加载时间 = 内容完全加载出来那一帧的时间 - 点击时的起始帧时间</li></ul><p>首屏时间的标准，因为缺乏海量的数据，也无法直接使用之前的秒开率的标准，我可以退而求其次，采用不用网络环境下的性能标准。</p><table tabindex="0"><thead><tr><th style="text-align:center;">类别</th><th style="text-align:center;">快</th><th style="text-align:center;">较快</th><th style="text-align:center;">慢</th><th style="text-align:center;">很慢</th><th style="text-align:center;">指标示例</th></tr></thead><tbody><tr><td style="text-align:center;">时间敏感（4G、wifi环境）</td><td style="text-align:center;">&lt;1s</td><td style="text-align:center;">1s ~ 1.5s</td><td style="text-align:center;">1.5s ~ 2.5s</td><td style="text-align:center;">&gt;2.5s</td><td style="text-align:center;">首屏、白屏</td></tr><tr><td style="text-align:center;">时间不敏感（2G、3G 网络）</td><td style="text-align:center;">&lt;2s</td><td style="text-align:center;">2s ~ 4s</td><td style="text-align:center;">4s ~ 8s</td><td style="text-align:center;">&gt;8s</td><td style="text-align:center;">onload</td></tr><tr><td style="text-align:center;">最佳：白屏 &lt; 1s，首屏 &lt; 1.5s，onload &lt; 3s</td><td style="text-align:center;"></td><td style="text-align:center;"></td><td style="text-align:center;"></td><td style="text-align:center;"></td><td style="text-align:center;"></td></tr></tbody></table><p>连续5帧超过50ms，判定为卡顿，单帧渲染超过250ms，就可以判定为严重卡顿。</p><h2 id="性能测试环境搭建及测试" tabindex="-1">性能测试环境搭建及测试 <a class="header-anchor" href="#性能测试环境搭建及测试" aria-label="Permalink to &quot;性能测试环境搭建及测试&quot;">​</a></h2><p>所谓的性能测试环境搭建，不是指需要搭建测试服务器及接口测试等，而是寻找合适的网络环境进行测试。</p><p>在专项测试的时候，为了提前发现性能问题，我们需要考虑得到各种网络环境下的情况。</p><ul><li>比如在58同城，各个业务都有自己的前端团队，每个团队开发完成的页面，需要集成到 58 APP 里面，APP要求各个业务在性能结果方面达标。像2G网络环境，由于在一定区域内，使用 2G 网络的人越少它的信号越好，所以房产业务的前端和测试工程师，会深更半夜拿着手机，在公司旁边四处找 2G 网络信号好对的的地方录屏以作测试。</li><li>腾讯微信团队对第三方和接入的H5，也会到周围各种网络环境下进行性能测试。</li></ul><p>寻找网络环境的经验：</p><ul><li>一般 4G 信号容易受物体遮挡或者天气的影响，在空旷滴滴点，天气晴朗情况下信号会明显好很多。</li><li>2G/3G 的好，一般来说信号很稳定，在办公区域或者wifi信号强的地方，使用弱网等人少时，信号一般是不错的，比如星巴克的咖啡厅是首选的测试地点。</li></ul><p>需要注意的是，此时的测试不要求平均时间，不需要关注首屏秒开率，只要在某种特定网络环境下首屏时间达标即可。</p><ul><li>通过人工计算首屏时间的话，前后偏差几百毫秒非常正常，准确性没有保证</li><li>人工判断，效率低，且没法和整体测试链路打通。比如测试团队还需要对内存占用、CPU使用情况、流量、APP崩溃率等进行测试，如果通过手动计算，就没法一次性采集到所有指标。</li></ul><p>所以，一般我会建议采取分帧计算的方式进行。具体步骤如下：</p><ul><li>安装 OpenCV、python，通过 Python 的 VideoCapture 将视频分帧存储</li><li>分帧图片命名，使用当前视频播放时间位置（毫秒）命名存储图片</li><li>首屏时长计算 = 首屏结束帧文件名</li></ul><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><ul><li>在视频分帧计算时，我们 openCV 最好能借助 brew（Mac环境下）进行安装，Windows 等环境下可以通过 Anaconda 来安装这个软件</li><li>计算首屏时间方面，我们前文提到的首屏时间判断，是通过人工提取对应首屏时间那一帧，我们后来试着用图像识别的方式来自动提取首屏时间对应的那一帧，这样能提高准确度和效率</li></ul><p>在拿到视频分帧计算结果后，通过图像识别的系统去判断关键帧（首屏时间对应那一帧）。</p><p>关键帧：图片从不稳定到图片稳定那一刹那就是关键帧。当两张图片的变化值小于 5%，即可认为图片趋于稳定（视觉稳定）。</p><p>问题：里面并没有提卡顿指标 FPS 如何提取，请问如何利用本讲的性能测试方案去获取呢？</p>`,43)])])}const g=i(l,[["render",n]]);export{k as __pageData,g as default};
