import{_ as e,c as a,o as i,ae as o}from"./chunks/framework.Ba8ARF_W.js";const s=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"note/performance/8.诊断清单：如何实现监控预警并进行问题诊断.md","filePath":"note/performance/8.诊断清单：如何实现监控预警并进行问题诊断.md"}'),r={name:"note/performance/8.诊断清单：如何实现监控预警并进行问题诊断.md"};function p(t,l,n,u,d,_){return i(),a("div",null,[...l[0]||(l[0]=[o('<h2 id="引言" tabindex="-1">引言 <a class="header-anchor" href="#引言" aria-label="Permalink to &quot;引言&quot;">​</a></h2><p>假设你已经根据我的介绍搭建好了，接下来要做什么呢？</p><p>搭建性能平台的主要目的：监控预警和对性能问题快速诊断，所以搭建完成后，我们还需要告诉大家怎么去解决这些问题。</p><p>性能平台搭建还缺一个监控预警功能。</p><h2 id="监控预警" tabindex="-1">监控预警 <a class="header-anchor" href="#监控预警" aria-label="Permalink to &quot;监控预警&quot;">​</a></h2><p>借助 Node-schedule 做调度和定时任务的处理，通过 node-mailer 进行邮件报警。</p><h3 id="_1-准备预警数据" tabindex="-1">1. 准备预警数据 <a class="header-anchor" href="#_1-准备预警数据" aria-label="Permalink to &quot;1. 准备预警数据&quot;">​</a></h3><p>做完数据清洗之后，一个分支使用 Spark 做计算，另外一个分支使用 Flink 实时数据计算。</p><p>超过2s的数据，或者认定为卡顿的数据，直接标记为预警数据。</p><h3 id="_2-我们借助-node-schedule" tabindex="-1">2. 我们借助 Node-schedule <a class="header-anchor" href="#_2-我们借助-node-schedule" aria-label="Permalink to &quot;2. 我们借助 Node-schedule&quot;">​</a></h3><p>用一批定时任务将预警数据通过 Node.js 拉取数据到 MongoDB 的预警表中。</p><h3 id="_3-预警的展示过程" tabindex="-1">3. 预警的展示过程 <a class="header-anchor" href="#_3-预警的展示过程" aria-label="Permalink to &quot;3. 预警的展示过程&quot;">​</a></h3><p>根据预警方式不同，样式展示也不同。</p><p>预警的方式有三种：</p><ol><li>企业微信报警通知</li><li>邮件报警通知</li><li>短信报警通知</li></ol><p>以手机列表页为例，性能标准是首屏时间 1.5s，秒开率 90%，超过这个标准就会在性能平台预警模块展示。</p><ul><li>超出 10%，平台上会标红展示，并会发企业微信报警通知</li><li>如果超过 20%，会发借助 node-mailer 做邮件报警</li><li>如果超出 30%，会发短信报警通知</li></ul><p>因为通知要消耗通信资源，为了避免数据量太大而浪费资源，一般对 APP 首页核心的导航位进行页面监控即可。</p><h2 id="问题诊断" tabindex="-1">问题诊断 <a class="header-anchor" href="#问题诊断" aria-label="Permalink to &quot;问题诊断&quot;">​</a></h2><p>预警功能做好后，前端性能平台就可以对重要指标进行实时监督，发现性能问题需要先对问题进行诊断，然后看情况是否需要进一步采取措施。</p><ul><li>先确定是共性问题还是个例问题，个人如网络抖动、手机内存占用太多或者连了代理等，就不需要进行单独的优化了。</li></ul><p>那怎么判断呢？</p><ul><li>共性问题，我们可以通过大量用户的数据指标是否正常来判断。如果性能指标中的首屏时间的均值出现异常，就是共性问题。然后再去看是哪个终端机型下的问题，加载瀑布流是怎样的，会慢在哪个环节。</li></ul><p>比如天津用户反馈说发布页面加载比较慢，他是怎么做的呢？</p><ul><li>先看性能平台，发现在中国移动网络下发布页面的首屏时间均值很长，超过了 3s，说明这是共性问题。</li><li>然后看发布页面的加载时间瀑布流，发现一个负责上传图片的 JS 文件加载特别慢，原因是它在资源加载时被阻塞住了，阻塞它的是一个负责对图片上传后实施滤镜功能的文件。这个文件显然可以延迟加载，即上传完成后再加载也可以，于是调整完加载策略，解决了这个问题。</li></ul><p>发现大量用户的首屏指标没问题（也就是首屏时间、均值和峰位值没问题），就可以判断为个例问题。有别于共性问题可以从平台上定位出具体是哪个瓶颈点，个例问题一般需要客服联系用户去解决，不需要代码层面做什么。</p><p>根据过往对性能优化的经验，整理了一个诊断清单：</p><ul><li>全量 VS 增量 <ul><li>指页面加载特别是列表页加载数据慢的情况，要从数据加载是全量还是增量的角度去诊断问题。以京东APP列表页为例，首屏一般展示4条左右的商品数据，PC页首屏展示50条商品数据，后端数据接口一般是同一套，这时，APP 请求列表页返回 50 条数据就不合适了，更好的做法是分接口先拉取首屏所需的4条数据，然后在页面滚动或者下拉操作加载后续数据即可。值得注意的是，为了保证体验流畅，有时候我们会多加载几条，比如开始就加载6条，刚开始滚动到首屏结束时，第5条数据已经有了，与此同时，第7条数据也在请求，等后端返回即可。</li></ul></li><li>同步 VS 异步 <ul><li>是指页面加载时间过长的情形，是否因为接口同步加载导致的问题。比如电商 App 列表页一般需要先拉取导航位置图片和链接信息，然后去拉取商品列表信息。可以考虑同时拉取两个列表，中间有依赖关系的地方，集中到第一个接口中去获取，然后就可以并行请求两个接口了。</li></ul></li><li>实时 VS 缓存 <ul><li>指遇到接口数据或者静态资源加载时间过长的时候，要看一下是否因为使用了实时数据的角度导致的，是否可以缓存策略来解决问题。具体来说，如果是能够缓存的数据，如双十一活动的榜单，页面中的 JS、CSS资源，优先检查一下是否做了缓存处理，如果用的是实时数据，如商品实时的价格、库存实时的情况，要看一下是否会导致性能瓶颈。在不影响用户体验的前提下，还可以去看看某些数据是不是可以定时去更新，如用户购买榜单信息等，有关静态资源，如JS、CSS文件的缓存处理，比较好的办法是，将每次渲染的页面好做缓存，页面打开就展示，只对细微做更新，确保用户体验更好。</li></ul></li><li>原片 VS 压缩 <ul><li>是指遇到图片加载缓慢的问题，可以查看图片是否是原图。做一些无损或者有损压缩处理，以此提高加载速度，或者尽量不使用原始图片。优先使用 webp 等图片格式。为了提高性能，页面在展示时，可以先设置先展示成一张低质量的图片，遇到很多用户特别关注这张图片时，再做进一步的优化处理也不迟。</li></ul></li></ul><h2 id="效果评估" tabindex="-1">效果评估 <a class="header-anchor" href="#效果评估" aria-label="Permalink to &quot;效果评估&quot;">​</a></h2><p>做完一个性能优化项目之后，如何评估项目效果呢？</p><ul><li>如果仅仅给出项目的性能指标变化，并不足以触达业务同学的内心，最好的方式就是通过性能优化，提高业务数据指标。以电商APP为例，最关注的一个指标是访问用户到订单的转化，比如100个用户进来后成了3单，转化率就是3%，那么性能指标和转化率指标有什么关系呢？根据 Skilled.co 的数据展示，沃尔玛在线网站页面加载时间每减少1秒，转化率增加 2%。这个前提是当前页面的首屏时间远大于 1s，如果首屏已经秒开，提升将非常有限。</li></ul><p>具体怎么评估转化率指标呢？</p><ul><li>用优化前后两个版本对比的方式，去看转化率指标的变化，也就是你经常听到的 AB 测试。</li></ul><p>具体怎么做呢？</p><ul><li>以列表页性能优化项目为例，在做性能优化之前，先把列表分为 A、B 两个版本，这两个版本可以通过条件语句区分代码块，还可以通过模板和路由的方式来区分。A 版本是筛选项优化前的，B版本是帅选项优化后的，用 IF 语句在列表页代码里面做区分，如果当前需要展示版本 A，URL 参数中传入 version=A</li><li>当用户到了列表页假如购物车下单时，我们用代码在提交给购物车的订单上做一个标记（from=version），这样交易成功后，通过统计埋点就能统计到 A、B版本各自的订单转化率，转化率的变化就是列表页性能优化项目的优化数据。</li><li>这里需要注意一点，为了确保同一个版本波动率很小，在做对比之前，还要对列表页做 AA 测，也就是两个版本代码完全一样的测试，它们的差异在万分之一以下了，再去做 AB测试。</li></ul><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><p>效果评估时，我曾遇到过几次性能优化后页面转化率急剧降低的情况，具体是从 2% 降低到 1.3%，一开始并不知道哪个环节出了问题，最后经过层层排查，原来是兼容性方面导致的，在 iphone11 和 小米10下，会出现菜单列表无法滚动的情况，这个问题解决后，转化率升到了 3%。</p><p>所以性能优化项目一定要做好兼容性测试，特别是针对 Top10机型的手机和弱网环境。</p><p>问题：在做性能监控预警时遇到某个问题，因为性能问题不是短时间能解决掉的，导致预警邮件越发越多，后台拖慢了预警的速度，只能展示2个小时前的数据了，你想过这个问题怎么解决吗？</p>',39)])])}const c=e(r,[["render",p]]);export{s as __pageData,c as default};
