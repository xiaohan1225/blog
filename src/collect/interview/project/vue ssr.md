## 服务端渲染概念
服务端渲染（Server-Side Rendering，简称 SSR）是一种在服务器端将 Vue 组件渲染成 HTML 字符串的技术。在服务器端渲染完成后，将生成的 HTML 字符串发送到客户端，客户端只需要解析 HTML 字符串即可，无需等待 `JavaScript` 下载和执行，从而提高了首屏渲染速度，SEO也更为友好。

与之相对应的客户端渲染（Client-Side Rendering，简称 CSR）是在客户端下载和执行 `JavaScript`，然后通过执行 `JavaScript` 动态生成页面。

## SSR 与 CSR 的区别
### 渲染时机
- SSR：在服务端生成完整的HTML，浏览器拿到直接渲染。
- CSR：浏览器只拿到一个空的HTML，通过执行 `JavaScript` 动态生成页面。

### 首屏加载速度
- SSR：由于浏览器拿到的是完整的html，所以首屏加载速度更快。
- CSR：需要等待 `JavaScript` 下载和执行，首屏加载速度较慢。

### SEO 友好性
- SSR：由于浏览器拿到的是完整的html，所以搜索引擎爬虫可以抓取到渲染后的内容，SEO友好。
- CSR：由于浏览器拿到的是空的HTML，搜索引擎爬虫可能只能抓取到空的HTML，SEO不友好。

## SSR 的优势和挑战
优势：
1. 首屏渲染速度快，用户体验好。
2. SEO 友好，搜索引擎爬虫可以抓取到渲染后的内容，提高网站排名。
3. 共享链接的显示预览：在社交媒体上分享链接时，能够正确显示预览信息。

挑战：
1. 开发复杂度增加：需要处理服务端和客户端的代码，项目打包和部署都更为麻烦，开发成本也更高。
2. 性能开销：需要处理服务端渲染的性能开销，如服务器负载、缓存策略等。
3. 服务器资源：需要更多的服务器资源来处理渲染任务，特别是对于高并发场景。
4. 状态管理复杂：需要在服务器和客户端之间同步状态，防止数据不一致。

## vue的渲染机制
vue应用的渲染过程如下：
1. 初始化：通过请求拿到html后，包含 `<div id="app"></div>` 根元素和引入的 `JavaScript` 文件。
2. 解析：下载并执行 `JavaScript` 文件，初始化 Vue 实例。
3. 渲染：Vue 根据模板和数据，生成虚拟 DOM，并渲染成真实 DOM。

## vue spa的问题
1. 首屏渲染速度：当应用一旦庞大后，下载和执行 `JavaScript` 的时间会很长，导致白屏时间过长，影响用户体验。
2. SEO：搜索引擎爬虫可能无法爬取 SPA 页面的内容，因为它们不会等待 `JavaScript` 的执行，只能获取到只带有``<div id="app"></div>`的空 HTML 页面，抓取不到渲染后具体的 DOM 元素。
3. 社交媒体预览：在社交媒体上分享链接时，无法正确显示预览信息。

## vue ssr 核心原理

`Vue SSR` 的核心是将 Vue 组件在服务器端渲染成 HTML 字符串，然后将这个 HTML 字符串发送到客户端，客户端拿到 HTML 后，再通过 vue.js 客户端激活成可交互的应用。


## 面试题
### 说说 Vue3 服务端渲染（SSR）的原理，以及它与客户端渲染（CSR）的区别？
Vue3 服务端渲染（SSR）的原理是将 Vue 组件在服务器端渲染成 HTML 字符串，然后将这个 HTML 字符串发送到客户端，客户端拿到 HTML 后直接渲染，而客户端渲染则拿到的是一个空的 html，需要通过加载和执行 JavaScript 文件，动态生成HTML。

在SSR中，客户端访问页面时，服务端会根据对应的路由，渲染出对应的HTML，这会提升首屏加载速度和 SEO 性能，客户端拿到 HTML 后，通过 vue.js 的 `hydrate` 进行“激活”，使其变成一个可交互的 Vue 应用。

两者的主要区别在于：
- SEO： SSR 比 CSR 更有利于搜索引擎爬取。
- 性能：SSR 的首屏加载速度更快，但会增加服务器负载，需要更多的服务器资源和成本。CSR 依赖浏览器的计算能力，首屏加载速度较慢，但不需要额外的服务器资源。

客户端激活内容：
1. DOM 匹配与关联
- 将虚拟 DOM 与服务器渲染的 DOM 结构进行匹配
- 检查客户端生成的虚拟 DOM 是否与服务器渲染的 HTML 结构一致
- 如果发现不匹配，会退出混合模式并重新渲染整个应用

1. 事件处理绑定
- 为已有的 DOM 元素添加事件监听器
- 使静态页面变为可交互的

1. 数据响应式初始化
- 初始化 Vue 实例的响应式系统
- 将服务器注入的状态(如 Vuex store 状态)同步到客户端

1. 组件实例化
- 为每个服务器渲染的组件创建对应的 Vue 实例
- 但不会重新创建 DOM 元素，而是复用现有 DOM
1. 内部状态恢复
- 恢复组件的内部状态(如 data、computed 等)
- 确保客户端和服务器端的状态一致

### Vue SSR 中如何解决首屏数据获取问题？
在 Vue SSR 中，首屏数据通常需要再服务端中完成，常用的方法在组件中定义一个 `asyncData` 函数，在组件渲染之前，先调用 `asyncData` 获取数据，然后将数据注入到组件中，再进行渲染。

具体步骤为：
1. 在服务器端，在SSR渲染函数中，先调用组件的 `asyncData` 方法获取数据，再将数据注入到 Vue 组件的 props 中。
2. 在客户端，Vue 会利用 `hydrate` 方法进行激活，接管服务端生成的 html，客户端还会将服务端预取的数据作为初始状态传递，避免重复请求。
  
数据预取的关键在于服务端需要等待数据加载完毕再渲染页面，以保证给客户端的 HTML 包含实际的数据。

> 服务端渲染的数据请求会在服务端完成，这样做的好处一个是请求速度快（内网请求、服务器的网络比客户端稳定），还一个好处是数据安全，因为数据请求是在服务端完成的，接口不会暴露给用户，接口数据也不会被随意更改。

### 如何在 Vue SSR 项目中处理路由和同步状态问题？
在 Vue SSR 项目中，为了保证服务器和客户端渲染的结果一致，需要处理路由和状态同步问题，可以通过以下方式解决：

1. 路由同步：在服务器端根据请求 URL 手动调用 `router.push` 切换到正确的页面，然后通过 `router.isReady()` 等待所有异步组件加载完成后，再进行服务端渲染，客户端则会根据当前的 URL 初始化路由。
2. 状态同步：在服务器端渲染时，将 Vuex/Pinia store 的状态通过 JSON 序列化的方式注入到 HTML 中，然后在客户端激活时，将 HTML 中的状态同步到 Vuex/pinia store 中，确保客户端和服务器端的状态一致，同时客户端也不需要再次请求数据。