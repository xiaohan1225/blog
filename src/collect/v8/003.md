---
title: 003 V8的快属性和慢属性
date: 2021-05-03
categories: 
 - JavaScript
tags:
 - JS引擎V8
sidebar: 'auto'
---

javascript中的对象是一组组属性和值的集合，类似于数据结构中的**字典**，字符串作为键名，任意对象可作为键值，通过键名可以读取键值。

不过V8在实现对象存储的时候。并没有采取字典这种存储结构，因为字典是**非线性**的存储结构，查询效率较低。

这里提到了两个概念：
1. 字典

字典（dictionary）是一些元素的集合。每个元素有一个称作key的域，不同元素的key各不相同，其操作有查询、插入和删除。

2. 非线性结构

线性结构的特点是**存储连续**，每个位置之间的偏移量固定，通过线性结构的首位和对应位置的下标就可以算出数据存储的位置，假设首位的位置为s，每个位置的偏移量为8，索引为i，那么这个线性结构任意位置的的计算公式为：
```js
p = s +  i * 8
```
这也是索引值从0开始的原因之一，因为如果从1开始的话公式就变为p = s +  (i - 1)* 8，多了一次减运算。线性结构的代表为数组、队列、栈等。

非线性结构的特点是**零散分布**，比如堆、链表、字典等。

线性结构由于存储连续，虽然查询快，但是能存储的容量有限，因为在内存中很难找到一块很大的连续空间。非线性结构虽然查询慢，但能存储的数据量大。

为了提高效率，v8采用了一套复杂的存储策略。我们来看看v8到底是如何访问对象中的属性的？

首先，要对属性进行分类。

1. 根据属性类型的不同，可分为**排序属性**和**常规属性**。

## 排序属性（elements）和常规属性（properties）
我们把对象中的数组属性称为**排序属性**，字符串属性称为**常规属性**。根据ECMAScript规范，**数字属性应该按照索引值大小升序排列，字符串属性应根据创建时间升序排列。**
```js
function Factory() {
  this[3] = '3'
  this['c'] = 'test-c'
  this[1] = '1'
  this['a'] = 'test-a'
  this['h'] = 'test-h'
  this[2] = '2'
  this['b'] = 'test-b'
}
const foo = new Factory()
for(let key in foo) {
  console.log(key)
}
// 打印结果
/**
1
2
3
c
a
h
b
*/
```
为了提高存储和访问性能，v8采用了两个**线性结构**来分别保存排序属性和常规属性，具体结构如下图所示：
<img :src="$withBase('/js/v8/v8内部的对象构造.svg')" alt="图片加载失败">

如果执行遍历操作，v8会先从elements属性中按照顺序读取所有的元素，然后再在properties属性中读取所有的元素。

增加了elements属性和properties属性后，无疑是简化了程序的复杂度，但却增加了一层属性读取，反而降低了访问速度，于是v8推出了块、慢属性和对象内属性。

2. 根据属性访问速度的不同，可将属性分为**快属性**和**慢属性**。

## 快属性和慢属性
在对象的常规属性很少的时候，v8会把部分常规属性直接存储到对象本身，提高查询效率，我们把这些属性称为**对象内属性（in object properties）**。如下图所示：

<div class="img-box">
  <img :src="$withBase('/js/v8/对象内属性.svg')" alt="图片加载失败">
</div>

对象内属性的数量是固定的，最多10个，如果添加的属性超过了对象分配的空间，则会将它们保存在常规属性中。常规属性虽然多了一层中间层，但扩容比较方便。

快属性：保存在线性数据结构中的属性。其查询速度块，但添加或删除大量属性时较慢。
慢属性：保存在非线性数据结构中的属性。v8的对象的属性一旦过多，就会采用非线性结构词典进行存储。

