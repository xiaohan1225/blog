## 引言
在性能诊断和优化当中，首屏秒开是其中非常重要的一环，可以说前端性能优化最重要的一个目标就是保证首屏秒开。

那么，如何优化来保证这一点呢？

## 懒加载
懒加载是性能优化的前头兵。

懒加载是指在长页面加载过程时，先加载关键内容，延迟加载非关键内容。比如之前提到的，如果首屏只需要几条数据，后端接口一次可以吐出 50 条数据，这会导致请求时间过长，首屏特别慢。

可以先根据手机的可视窗口，估算需要多少条数据，然后超出首屏的内容，可以在页面下拉或者滚动时再发起加载。

如果首页当中图片比较多，如何保证首屏秒开呢？
- 同样也可以采用懒加载，以百度图片列表页为例，一般会根据不同手机机型估算一个最大数据，比如 Iphone 12Pro 屏幕比较大，4行8条数据，我们就先请求8条数据，用来在可视区域展示，其它位置采用占位符填充，在滑动到目标区域位置后才使用真实的图片填充。

## 缓存

如果说懒加载本质是提供首屏后请求非关键内容的能力，那么缓存则是赋予二次访问不需要重新请求的能力。

在首屏优化方案中，接口缓存和静态资源缓存起到中流砥柱的作用。

接口缓存：
- 如果是端内的话，所有请求都走 Native 请求，以此来实现接口缓存。为什么要这么做呢？APP中的页面有两种形式，使用 Native 开发的页面展现和使用 H5 开发的页面展现，如果统一使用 Native 接口请求的话，已经请求过的数据就不用再请求了，如果使用 H5请求数据，必须等 WebView 初始化之后才能请求，也就是串行请求，使用 Native 请求的话，可以你在 Webview 初始化之前就开始请求，也就是并行请求，这样能有效的节省时间。

如何通过 Native 来进行接口缓存呢？
- 我们可以借助 SDK 封装来实现，即修改原来的数据接口请求方法，实现类似 Axios 的请求方法，具体来说就是，把 get、post等方法封装进 SDK 中，这样客户端在发起请求时，会调用 SDK 中 axios方法，Webview会拦截这个请求并去查看 App本地是否有数据缓存，如果有的话，就走接口缓存，如果没有的话，先向服务端请求数据接口，获取接口数据后存放到 App缓存中。

静态资源缓存：
- 数据接口的请求一般来说较少，只有几个，而静态资源（如JS、CSS、图片和字体等）的请求就太多了。

如何做静态缓存方案呢？
- 一种是静态资源长期不需要修改（使用强缓存，通过设置 Cache-Control=max-age=31536000来让浏览器在一年内使用本地缓存文件，而不是向服务器发出请求。）
- 一种是静态资源修改频繁的（可以通过设置Etag实现协商缓存，在初次请求资源时，设置 Etag，并且返回 200 的状态码，之后请求时带上 If-none-match 字段来询问服务器当前版本是否可用，如果服务端数据没有变化，会返回一个 304状态码给客户端，告诉客户端不需要请求数据，直接使用之前的缓存的数据即可，这里设计webview相关的会放在15讲展开）

## 离线化

离线化是指线上实时变动的资源数据静态化到本地，访问时走的是本地文件的方案。离线包时离线化的一种方案，是讲静态资源存储到 APP 本地方案，不过这里主要讲的是离线化的另一种方案，把页面内容静态化到本地。
- 离线化一般适合首页或者列表页等不需要登录页面的场景
- 同时能够支持SEO功能

通过 `prerender-spa-plugin` 实现预渲染，进而实现离线化。

## 并行化
懒加载、缓存和离线化都是在请求本身上下功夫，想办法减少请求或者推迟请求，并行化则是在请求通道上下功夫，解决请求阻塞问题，进而减少首屏时间。这就像解决交通阻塞问题，除了限号，减少车辆，还可以增加车道数量。

在处理请求阻塞时，也可以加大请求通道数量，借助于 HTTP 2.0 的多路复用方案来解决。

HTTP 1.1 时代有两个性能瓶颈点，串行的文件传输和同域名的连接数限制（6个），到了 HTTP 2.0 时代，提供了多路复用的功能，不再以文本的方式传输，也是采用二进制数据帧和流的方式进行传输，其中帧是数据接收的最小单位，流是连接中的一个虚拟通道，它可以承载双向信息，每个流都会有一个唯一的整数 ID 对数据顺序进行标识，这样接收端接收到数据时，可以按照顺序进行合并，不会出现数据出错的情况。所以在使用流的情况下，不论多少个资源请求，只要建立一个连接即可。

文件传输环节问题解决后，同域名链接数限制问题怎么解决呢？
- 以 Nginx 服务器为例，原先因为每个域名有 6 个连接数限制，最大并发就是 100 个请求，采用 HTTP 2.0 之后，现在则可以做到 600，提升了 6 倍。

这不是运维侧要做的事情吗，我们前端开发需要做什么？
- 我们要改变静态文件合并、静态域名服务器做域名散列这两种开发方式，具体来说，使用 HTTP 2.0 多路复用之后，单个文件可以单独上线，不需要再做 JS 文件合并了。为了解决静态域名阻塞，提升请求并行能力，需要将静态域名分为 pic0-pic5，虽然通过静态资源域名散列的方式解决了问题，但这样的话DNS解析时间也会变长，同时需要额外的服务器满足，如今采用 HTTP 2.0多路复用之后，也不需要这么做了。

## 小结
在实际工作当中，前端工程师还会用到离线包和 SSR，但 SSR的实现比较重，要做的改造比较多，对于端外和 PC 站不具有普适性。所以这里着重介绍了懒加载、缓存、离线化、并行化这四种具有普适性的优化方案。

思考：懒加载、缓存、离线化、并行化这四种方案，分别解决性能加载过程中哪个瓶颈点的问题呢？
- 懒加载：服务端响应阶段、客户端渲染阶段
- 缓存：服务端响应阶段、数据缓存阶段、客户端渲染阶段
- 离线化：客户端发起请求阶段
- 并行化：客户端发起请求阶段