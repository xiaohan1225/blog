聊聊前端其他的性能指标采集，比如白屏、卡顿和网络环境

举个例子
- 首屏时间：过安检的时刻
- 白屏时间：排队到安检点的时间
- 卡顿：排的队伍停止

浏览器的白屏和卡顿直接影响用户的体验，影响用户对平台的信任。网络环境的影响更大，同时也是性能优化的盲区。

## 白屏指标采集

从输入内容回车（包括刷新、跳转等方式）后到页面开始出现第一个字符的时间。

浏览器的页面加载过程：
- 客户端发起请求
- 下载 HTML 及 JS/CSS 资源
- 解析 JS 执行
- JS 请求数据
- 客户端解析 DOM 并渲染
- 下载渲染图片
- 完成整体渲染

白屏时间 = 页面开始展示的时间点 - 开始请求的时间点

白屏时间 FP = domLoading - navigationStart


App 下的页面加载过程：
- 初始化WebView
- 客户端发起请求
- 下载 HTML 及 JS/CSS 资源
- 解析 JS 执行
- JS 请求数据
- 服务端处理并返回数据
- 客户端解析 DOM 并渲染
- 下载渲染图片
- 完成整体渲染

App下的白屏时间，多了启动浏览器内核，也就是 Webview 初始化的时间，这个时间必须通过手动采集的方式来获得，而且因为线上线下时间差别不大，线下采集即可。
- APP创建 Webview 时打一个点，开始建立网络连接再打一个点，两个点的时间就是 Webview 初始化的时间

## 卡顿指标采集
卡顿：简单来说就是页面出现卡住了的不流畅的情况。

FPS（Frames Per Second，每秒显示帧数），大多数资料提到 FPS 在 60 以上页面流畅，不卡顿，但事实上并非如此。比如我们看电影或者动画时，虽然 FPS 是30低于60，但我们仍然觉得流畅并不卡顿。

那 FPS 高于 60 是否意味着一定不卡顿呢？
- 前 60 帧渲染很快（10ms 渲染 1 帧），后面的 3 帧渲染很慢（20ms 渲染1帧），这样平均起来 FPS 为 95。虽然 FPS 很高，但实际效果是卡顿的。

关键点在于单帧渲染时间是否过长，但在浏览器上，我们没办法拿到单帧渲染耗时的接口，所以这时候，只能拿 FPS 来计算。

**连续 3 帧不低于 20 FPS，且保持恒定。**

在浏览器环境，用 requestAnimationFrame 计算 FPS

在 APP 环境，app可以直接拿到单帧渲染时长。

一般连续5帧超过 50ms，判定为卡顿，单帧渲染超过 250ms，就可以判定为严重卡顿。

导航 APP 无法判断某个地点是否出了问题，但可以借助 GPS 和定位仪，拿到你两个节点之间的行驶数据，就可以推断出这个地点是否拥堵。

为什么会出现 App 白屏时间过长或卡顿问题呢？
- 一般 WebView 初始化慢，DNS 解析慢、视图树过于复杂和主线程被阻塞等都会导致问题出现，但很多情况下白屏时间和卡顿都和网络环境有关。


## 网络环境采集

在 APP 内，可以通过 APP 提供的接口获取到网络情况，在端外就没法直接拿到当前网络情况了，这时怎么办呢？
- 一个做法是拿到两张不同尺寸图片的加载时间，通过计算结果来判断当前网络环境。
  - 每次页面加载时，通过客户端向服务端发送图片请求，然后在图片请求之初打一个时间点，在图片 onLoad 完成后打一个时间点，两个时间点之差，就是图片的加载时间。比如请求一张 1 x 1像素和一张 3 x 3像素的图片，计算图片的加载时间后，用文件体积/加载时间，就能得到两张图片的加载速度，然后把两张图片的加载速度求平均值，这个结果就可以当作网络速度

每个单页面启动时，都会做一次网速采集，得到一个网络速度，把这些网络速度做概率分布，就能得出当前网络情况。2G、3G、4G、5G、WiFi、离线等。比如 50%的用户在 4G，40%的用户在 wifi，这个可以看出大部分用户处于哪个网络，然后针对做优化。


## 小结
详细讲了白屏时间采集、卡顿指标采集和网络环境采集，有了这个采集，我们就能很容易定位用户体验层的很多问题。

白屏部分，里面提高的更偏加载阶段的白屏，实际工作中我们会遇到不少广义上的白屏。
- 后端接口导致的白屏
- 数据加载中产生的白屏
- 图片与视频加载过程中的白屏

这些广义的白屏问题怎么采集监控呢？