## 引言
首屏时间、白屏时间、卡顿等的优化方案，它们一般适用于 App 端内和端外的两种场景，App端内就是 App 内的 H5 页面，端外是指 PC 站或者微信里面的 H5 等页面。

- Hybrid 开发模式借助 WebView，把 Native 和 H5 的各自优势进行了结合，具备 Native 体验好，操作硬件能力强，代码安全等优势，又具备H5发版节奏快，web标准开发效率高等优势，通过它，前端工程师几分钟内就能完成需求上线，不用等 App 一周的发版周期，不用等待审核。
- Hybrid 开发模式还可以将一个大的横向需求切分到各个业务前端团队并行工作，大大提升了需求吞吐率和迭代速度。许多大厂比如美团、淘宝、去哪儿都采用这种开发模式。

缺点也很明显，比如加载性能问题，白屏问题，界面展示和操作的局限性，无法使用系统功能等等。

结合 H5 的加载流程，介绍 Hybrid App 下的性能优化整体分析，然后接下来几讲会详细介绍与之相关的具体优化。如离线包，图片骨架屏、服务端渲染、接口预加载、客户端代理数据接口等。

H5 是 Hybridd App 当中的一个核心，它可以通过 SDK 访问 App 底层系统，让前端页面获取调用传感器、存储、日历/联系人等原生能力。

加载流程如下：
- 进入APP
- 初始化 WebView
- 客户端发起请求
- 下载 HTML 及JS/CSS 资源
- 解析 JS 执行
- JS 请求数据
- 服务端处理并返回数据
- 客户端解析 DOM 并渲染
- 下载渲染图片
- 完成整体渲染

初始化 Webview 之前都算是 App 启动阶段，从初始化 Webview 到客户端解析 DOM 并渲染，属于是白屏时间，剩下的环节就是整体渲染到首屏结束。

## App 启动阶段的优化方案

App 启动，尤其是冷启动（首次启动 App）时，并不会直接初始化 Webview，而是在创建 Webview 实例时，才会创建它的基础框架。系统打开 Webview 时，也不是直接建立连接发起请求，而是又一个启动浏览器内核的过程。

在一次二手业务列表页测试时发现，首次启动 WebView 平均需要 400ms 左右，二次启动平均又 200ms，按照页面秒开的目标，WebView 启动就占了 40% 的时间。

建议使用 WebView 全局对的优化方式，在 App 启动时启动一个 WebView 后让其全局化，或者更彻底一点，把 Webview 的实例保存在一个公共池中，当用户访问这个 WebView 时，直接从公共池取来加载网页，而不是重新初始化一个新的 webview。（可以减少 200ms 左右的启动时间）

## 页面白屏阶段的优化方案

H5 页面加载的下载HTML及JS/CSS资源环节当中，会有哪些情况影响性能，以及会用到哪些优化方案呢？

一般情况下，前端工程师将静态资源上线到CDN后，webview 会发起网络请求去获取。如果我们能将静态资源提前下载到本地，webview 获取静态资源时就可以直接从本地获取，这样会大幅降低白屏时间。

离线包就是将包括 HTML、JavaScript、CSS 等页面内静态资源打包到一个压缩包内，App预先内置该压缩包到本地，然后当用户在客户端打开 H5 页面时，直接从本地加载。

离线包提前下载到本地，那么更新问题如何解决呢？
- 可以在生成离线包的同时，生成一个配置文件，让App先根据这个静态文件判断是否需要更新离线包，还是直接向业务服务器进行请求。

如果静态资源本地版本实在太老，此时客户端将直接向服务器请求资源怎么办呢？
- 优化方案就是骨架屏————我们可以给客户一个心理预期，在接口请求和渲染过程中，让他知道接下来要渐进式展示的内容和结构是什么（需要 UI 去做图，需要客户端去展示和关闭）
- 骨架屏可以“加快”过程中的等待时间，但请注意，这个加快只是视觉和心理上的效果。

有没有办法减少最后的渲染时间呢？
- SSR（Server Side Rendering，服务端渲染）是指客户端发起页面请求后，服务端直接将组件和页面内容渲染成 DOM 结构，返回给客户端。 

## 首屏渲染阶段的优化方案

这阶段要解决的主要问题是怎样减少数据接口加载的时间。
- 一方面，我们可以通过服务端优化来降低后端接口的响应时间。如从200ms降低到100ms，但是100ms以下就很难有优化空间了。
- 另一方面，可以从接口和页面并行加载的角度，去做优化加载时间，也就是接口预加载。
  - 第一种，通过客户端代理数据接口请求。在客户端初始化 webview 的同时，直接由 native 发起网络请求，H5 页面初始化完成后直接通过 SDK 向 native 获取数据。
  - 第二种，根据业务场景选择预加载。比如在滚动下拉列表的页面，根据用户滚动条的位置，提前加载一页的展示数据，这样用户在滚动下拉时，不会有停滞的感觉，非常流畅。
  - 第三种，在一些旅行类 App 上，比如用户在订酒店的时候，当他进行目的地和日期选择之后，将结果上传服务端，服务端会根据用户的操作路径，判断打开搜索结果页的概率。如果概率超过某一个值，就会启动搜索结果页的数据获取，这样在进入搜索结果页后，已经有了接口数据，大大节省了时间。

## 小结

以 App H5 的加载流程，介绍了 Hybrid 下的整体优化方案。

注意事项：
- 离线包命中率的统计，因为离线包即便不命中也不影响页面效果，所以出现问题很难发现，为此，在业务上线的日常运行中要对命中率进行统计。
- Webview 的优化，全局 webview pool 时一定要注意及时销毁，不然会 App 资源的占用会比较大。
- 很多公司在预加载数据的基础上发展出了预渲染，但在实施过程中我们发现，它对 App内存占用过大。 