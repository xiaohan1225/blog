## 页面变的缓慢，哪里出了问题？
- 网络问题
- 后端接口问题
- 用户手机环境问题

拿性能优化标准和预警监控平台收集到的数据对比，就知道问题出在哪里。

## 性能优化体系
### 性能优化流程
- 指标设定：选择什么样的指标，比如页面打开慢从哪些地方入手，优化完怎么知道问题解决了？
- 性能标准：性能优化目标是怎样的？优化到什么程度合适？比如优化 APP 内 H5 页面的打开速度，确定的指标是秒开率，1秒内打开的请求比例就是它的性能标准。
- 收益评估：很多时候，为了让产品同学感觉我们是为产品服务，而不是又在造轮子，还需要关联产品目标进行收益预估。比如列表页到详情页的转化率能不能提升，用户跳出率能不能降低等。
- 诊断清单：把业务代码接入性能监控预警平台，根据性能标准给出诊断清单。
- 优化手段：前一步诊断出的性能问题，就可以结合性能标准和诊断清单，确定对应的优化方案。
- 性能立项：性能项目立项是赢得产品经理、后端同事支持，让优化顺利执行下去不可或缺的内容。
- 性能实践：经过优化之后发起项目上线，并跟踪进行效果评估，结合场景把这些项目成果以文档或代码的形式沉淀下来。（制定优化实践、确保新人也可以执行，是优化成果得以长期保持的必要保障）

### 性能指标采集和上报
- 指标分解
- 指标采集
- SDK 封装
- 统计埋点
- 上报策略
- 数据预处理

主要内容是把前端提到的性能优化指标以代码的形式分解落地，确保可以采集，然后在 SDK 封装后集合统计埋点，最后根据实际情况，制定上报策略。（丢弃异常数据，避免占用网络带宽）

### 性能监控预警平台
- 数据展示、性能监控、数据预警、性能前台
- Kafka、Spark、离线 Job、性能后台
- 性能数据存储（MySQL + MongoDB + Hive + HDFS）

当指标超过某一监控阈值时，性能监控预警平台会通过钉钉、短信或邮件，给我们发送预警信息。

- 性能数据处理后台：主要是在性能采集数据上报到性能平台后，对数据进行预处理、数据清洗和数据计算，然后生成前台可视化所需数据。
- 性能可视化展现前台：主要是对核心数据指标进行可视化展现，对性能数据波动进行监控，对超出阈值的数据给出钉钉、短信或邮件报警。

### 性能专项测试
在上线前一定要做性能专项测试，检查采取的措施和性能优化预期是否一致。
- 能否正确发出请求
- 请求处理流程是否正确
- 性能平台和数据能否展现


## 什么样的指标值得我们关注？
- 可衡量，就是可以通过代码来度量
- 关注以用户为中心的关键结果和真实体验
  - 用户真正关心什么，比如用户进行商品详情页面，他关心的是这个商品怎么样，具体到页面就是商品描述、商品头图、商品价格和购买按钮这些关键信息
  - 用户使用产品的感受，比如用户进行列表页，在滑动过程中，页面加载突然跳出一个弹窗，他会不会觉得烦？

## 性能优化关键指标设定和标准

### 加载性能指标
加载：就是进入页面时，页面内容的载入过程。当你打开一个网站时，有些网站的文字、图片出现很缓慢，有的则很快，这个内容出现的过程就是加载。

白屏时间：指的是从输入内容回车（包括刷新、跳转等方式）后到页面开始出现第一个字符的时间。它的标准时间是 300ms。

哪些因素会影响白屏时间？
- DNS 查询时间长，建立 TCP 请求链接太慢
- 服务器处理请求速度太慢
- 客户端下载、解析、渲染时长过长，没有做 Gzip 压缩
- 缺乏本地离线化处理等

首屏时间 = 白屏时间 + 渲染时间。从浏览器输入地址并回车后，到首屏内容渲染完毕的时间，这期间不需要滚动鼠标或者下拉页面，否则无效。

- 从**重要性角度**看，打开页面后，第一眼看到的内容一般都非常关键，比如电商的头图、商品价格、购买按钮等。这些内容即使在最恶劣的网路环境下，我们也要确保用户能看得到。
- 从**体验完成性角度**看，进入页面后先是白屏，随后第一个字符加载，到首屏内容显示结束，我们才会认为加载完毕，用户可以使用了。

首屏时间的标准，最初只是根据这个页面对时间是否敏感来判定，主要以用户平均首屏加载时间来计算，并没有详细区分 2G/3G/4G/5G/WiFi 这些网络环境。

比如百度文库：
| 类别 | 快 | 较快 | 慢 | 很慢 | 指标示例 |
|:---------:|:---------:|:---------:|:---------:|:---------:|:---------:|
| 时间敏感   | <1s   | 1s ~ 1.5s   | 1.5s ~ 2.5s   | >2.5s   | 首屏、白屏   |
| 时间不敏感   | <2s   | 2s ~ 4s   |  4s ~ 8s    | >8s   |onload   |
| 最佳：白屏 < 1s，首屏 < 1.5s，onload < 3s。|

首屏时间在 1s 内，用户感觉会很快，如果首屏时间超过 2.5s，用户就会感觉很慢。但是在 1s 内打开页面，人们对这么短的时间并不敏感，体验不出 10ms 和 50ms 有什么差别。

当到了 2G/3G 弱网环境，或者网络不稳定环境，用户联网加载的时间会特别长，严重影响整体指标。所以用平均值来表示加载时间并不准确可靠。所以人们又开始采用中位数，做正态分布，看分位值统计。P50（50分位值）、P90（90分位值）、P99（99分位值）。以 P99 为例，我们是把所有首屏时间排序，得出排在第99位的首屏时间就是 P99。但这样还是比较麻烦，所以引入了秒开率的指标，即 1s 内打开用户的占比。

按照秒开率建立的首屏时间标准：

| 类型 | 首屏时间 | 秒开率 | 1.5秒开率 | 2秒开率 |
|:---------:|:---------:|:---------:|:---------:|:---------:|
| SSR  | 1000ms   | 80%   | 95%   | 98%  |
| 端内   | 1200ms  | 65%   |  85%    | 90%   |
| 端外   | 1500ms   | 40%   |  60%    | 80%   |

问题：首屏时间毕竟粒度太粗了，如果首屏时间长，白屏时间短，到底是哪里的问题？数据接口的问题，还是页面渲染的问题。

首屏时间可以拆分为白屏时间、数据接口响应时间、图片加载资源时间等。
- 数据接口响应时间可以直接从后端服务中获取，不需要前端再重复计算。只需要取完后放在性能平台即可。
- 图片加载时间需要单独采集。

### 交互性能指标
交互：就是页面点击网站或 APP 某个功能页面给出的回应。比如点击了一个 “点赞” 按钮，立刻给出了点赞数 +1 的展示，这就是用户体验好。

- 有些公司用 FID 指标（First Input Delay，首次输入延迟），指标必须尽量小于 100 ms。
- 有些公司使用 PSI（Perceptual Speed Index，视觉变化率），衡量标准是小于 20%。

### 视觉稳定性指标

CLS（Cumulative Layout Shift） 也就是布局偏移量，它是指页面从一帧切换到另外一帧时，视线中不稳定元素的偏移情况。

比如要购买的商品正在参加抢购活动，正要点击页面链接购买的时候，原来的位置插入了一条 9.9 元包邮的商品广告，结果点成了那个广告商品。当你返回商品详情时，发现抢购活动已经结束。

视觉稳定性指标 CLS 比较前言，2020.5 Google 公司才发布一篇关于 CLS 指标定义和相关介绍的文章，它的采集方法，除了依赖 Google 的 Lighthouse 做本地采集，目前还没有好的方案。

### 业界指标
- 在性能优化关键指标方面，目前业界主要集中在加载方面，特别是白屏时间和首屏时间。
- 采集方式可以手动也可以自动。
- 交互性和视觉稳定性关键指标，业界还在探索，没有统一的衡量标准，且必须手动采集。