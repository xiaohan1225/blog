## 引言

如果有新业务要上线，如何尽量避免它上线后的前端性能问题，避免以后我们手忙脚乱去“救火”呢？

性能专项测试：在业务上线前，我们对性能指标（如首屏时间、白屏时间、页面加载时长等）进行测试，确保上线后性能指标达标。

步骤如下：
1. 确定线下测试方案
2. 设定线下的测试标准
3. 选用合适的测试环境进行测试及视频的分帧计算
4. 输出测试结果

## 性能测试方案选型

使用性能 SDK 和以录视频的方式。

性能SDK：优点是线上和线下的方案一致，缺点是因为业务还没上线，内网测试的访问量有限，无法形成大量的首屏时间分布数据，也就无法在性能平台上可视化数据。
- 比如我们要采集首屏时间指标，就使用 MutationObserver。

以录制视频的方式进行性能测试：优点是可以和 QA 现有基础设施（由于测试项目较多，在这个过程中，QA团队会沉淀一些基础设施，比如对 APP 代码覆盖率测试工具、异常测试平台、数据构造集成测试平台等）相结合，QA 测试不仅会测 H5 页面的首屏时间，还会测试 Native 页面的响应时间，以及 APP 内存使用和 CPU 占用等信息。

在性能测试上，我一般建议采用录制视频的方式来进行。

录制视频一般有手动方案和自动化方案。所谓手动方案就是通过手机自带的视频录制功能来进行，而自动化方案则是通过 adb 录制。

adb 是 android studio 下提供的一个工具，在电脑上通过它可以控制模拟器或者真实的手机设备，需要通过数据线连接到电脑。比如可以通过它打开一个 app 页面，运行 shell 命令，安装软件等功能。

```bash
# 录屏时间为 10 s，如果不设置默认时间是 180 s
adb shell screenrecord --time-limit 10 /sdcard/perf.mp4
```

打开一个 app 页面，页面开始加载，然后在页面加载结束后，点击 ctrl + c 结束录屏。

录制的坑：
1. 有些设备的显示如分辨率过高可能无法录制。可以通过指定分辨率来解决这个问题。

```bash
adb shell screenrecord --size 1280x720 --time-limit 10 /sdcard/perf.mp4
```
2. 如果使用模拟器。要注意模拟器在晃动、多点触摸等操作情况下替代不了真机，模拟器在性能和设备类型上也要慢一些，上限取决于你电脑的性能上限。
3. 录制过程中不要旋转手机，因为这会造成页面切断。
4. 可以通过添加 verbose 参数打印中执行过程中的信息，帮助调试。
```bash
adb shell screenrecord --time-limit 10 --verbose /sdcard/perf.mp4
```

## 性能测试标准设定

有关性能标准，我在第一讲里的关键指标设定介绍过，也在模块二专门说明了首屏时间、白屏时间、卡顿等的指标采集方案。

首屏时间的性能指标设定需要注意两点：
1. 分频计算的标准，也就是什么时候认为首屏结束。
2. 确定首屏时间的标准。

- 白屏响应时间 = 白屏最后一帧的时间 - 点击时的起始帧时间
- 首屏加载时间 = 内容完全加载出来那一帧的时间 - 点击时的起始帧时间

首屏时间的标准，因为缺乏海量的数据，也无法直接使用之前的秒开率的标准，我可以退而求其次，采用不用网络环境下的性能标准。

| 类别 | 快 | 较快 | 慢 | 很慢 | 指标示例 |
|:---------:|:---------:|:---------:|:---------:|:---------:|:---------:|
| 时间敏感（4G、wifi环境）   | <1s   | 1s ~ 1.5s   | 1.5s ~ 2.5s   | >2.5s   | 首屏、白屏   |
| 时间不敏感（2G、3G 网络）   | <2s   | 2s ~ 4s   |  4s ~ 8s    | >8s   |onload   |
| 最佳：白屏 < 1s，首屏 < 1.5s，onload < 3s |

连续5帧超过50ms，判定为卡顿，单帧渲染超过250ms，就可以判定为严重卡顿。

## 性能测试环境搭建及测试

所谓的性能测试环境搭建，不是指需要搭建测试服务器及接口测试等，而是寻找合适的网络环境进行测试。

在专项测试的时候，为了提前发现性能问题，我们需要考虑得到各种网络环境下的情况。

- 比如在58同城，各个业务都有自己的前端团队，每个团队开发完成的页面，需要集成到 58 APP 里面，APP要求各个业务在性能结果方面达标。像2G网络环境，由于在一定区域内，使用 2G 网络的人越少它的信号越好，所以房产业务的前端和测试工程师，会深更半夜拿着手机，在公司旁边四处找 2G 网络信号好对的的地方录屏以作测试。
- 腾讯微信团队对第三方和接入的H5，也会到周围各种网络环境下进行性能测试。

寻找网络环境的经验：
- 一般 4G 信号容易受物体遮挡或者天气的影响，在空旷滴滴点，天气晴朗情况下信号会明显好很多。
- 2G/3G 的好，一般来说信号很稳定，在办公区域或者wifi信号强的地方，使用弱网等人少时，信号一般是不错的，比如星巴克的咖啡厅是首选的测试地点。

需要注意的是，此时的测试不要求平均时间，不需要关注首屏秒开率，只要在某种特定网络环境下首屏时间达标即可。
- 通过人工计算首屏时间的话，前后偏差几百毫秒非常正常，准确性没有保证
- 人工判断，效率低，且没法和整体测试链路打通。比如测试团队还需要对内存占用、CPU使用情况、流量、APP崩溃率等进行测试，如果通过手动计算，就没法一次性采集到所有指标。

所以，一般我会建议采取分帧计算的方式进行。具体步骤如下：
- 安装 OpenCV、python，通过 Python 的 VideoCapture 将视频分帧存储
- 分帧图片命名，使用当前视频播放时间位置（毫秒）命名存储图片
- 首屏时长计算 = 首屏结束帧文件名

<!-- 代码 -->

## 小结
- 在视频分帧计算时，我们 openCV 最好能借助 brew（Mac环境下）进行安装，Windows 等环境下可以通过 Anaconda 来安装这个软件
- 计算首屏时间方面，我们前文提到的首屏时间判断，是通过人工提取对应首屏时间那一帧，我们后来试着用图像识别的方式来自动提取首屏时间对应的那一帧，这样能提高准确度和效率

在拿到视频分帧计算结果后，通过图像识别的系统去判断关键帧（首屏时间对应那一帧）。

关键帧：图片从不稳定到图片稳定那一刹那就是关键帧。当两张图片的变化值小于 5%，即可认为图片趋于稳定（视觉稳定）。

问题：里面并没有提卡顿指标 FPS 如何提取，请问如何利用本讲的性能测试方案去获取呢？